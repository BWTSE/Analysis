---
title: "Reuse"
output: html_notebook
---

Some plots of the data:

```{r}
d.completed %>%
  ggplot(aes(high_debt_version)) +
  geom_bar(aes(fill = reused_logic_constructor), position = "fill") + 
  scale_fill_manual("legend", values = c("true" = "green", "false" = "red")) +
  labs(title = "Constructor Reuse") +
  xlab("High Debt version") +
  ylab("Ratio of reuse")

d.completed %>%
  ggplot(aes(high_debt_version)) +
  geom_bar(aes(fill = reused_logic_validation), position = "fill") + 
  scale_fill_manual("legend", values = c("true" = "green", "false" = "red")) +
  labs(title = "Validation Reuse") +
  xlab("High Debt version") +
  ylab("Ratio of reuse")

d.completed %>%
  filter(has_equals == "true") %>%
  ggplot(aes(high_debt_version)) +
  geom_bar(aes(fill = reused_logic_equals), position = "fill") + 
  scale_fill_manual("legend", values = c("true" = "green", "false" = "red")) +
  labs(title = "Equals Reuse") +
  xlab("High Debt version") +
  ylab("Ratio of reuse")

d.completed %>%
  filter(has_hashcode == "true") %>%
  ggplot(aes(high_debt_version)) +
  geom_bar(aes(fill = reused_logic_hashcode), position = "fill") + 
  scale_fill_manual("legend", values = c("true" = "green", "false" = "red")) +
  labs(title = "HashCode Reuse") +
  xlab("High Debt version") +
  ylab("Ratio of reuse")

```

Initial model:

```{r}
reuse0 <- brm(
  mvbind(
    reused_logic_validation,
    reused_logic_constructor
  ) ~ 1 
  + (1 |c| session),
  family = bernoulli(),
  data = as.data.frame(d.both_completed),
  prior = c(
    prior(normal(0, 1), class = "Intercept"),
    prior(exponential(1), class = "sd", resp = reusedlogicconstructor),
    prior(exponential(1), class = "sd", resp = reusedlogicvalidation),
    prior(lkj(2), class = "L")
  ),
  control = list(adapt_delta = 0.95),
  #empty = TRUE
  #sample_prior = "only",
  file = "fits/reuse0",
  file_refit = "on_change"
)

pp_check(reuse0, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse0, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
prior_summary(reuse0)
summary(reuse0)
```

Adding debt level as predictor:

```{r}
reuse1.with <- extendable_model(
  base_name = "reuse1",
  base_formula = "mvbind(
    reused_logic_validation,
    reused_logic_constructor
  ) ~ 1 + high_debt_version + (1 | c | session)",
    base_priors = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(0, 1), class = "Intercept"),
    prior(exponential(1), class = "sd", resp = reusedlogicconstructor),
    prior(exponential(1), class = "sd", resp = reusedlogicvalidation),
    prior(lkj(2), class = "L")
  ),
  family = bernoulli(),
  data = d.both_completed,
  base_control = list(adapt_delta = 0.95)
)


reuse1 <- reuse1.with()
summary(reuse1)
```

Compare

```{r}
loo(reuse0, reuse1.with())

```


```{r}
summary(reuse1.with("work_domain"))
```

```{r}
summary(reuse1.with("work_experience_programming.s"))
```


```{r}
summary(reuse1.with("work_experience_java.s"))
```

```{r}
summary(reuse1.with("education_field"))
```

```{r}
summary(reuse1.with(
  "mo(education_level)", 
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicconstructor"),
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicvalidation")
  )
))
```

```{r}
summary(reuse1.with("workplace_peer_review"))
```

```{r}
summary(reuse1.with("workplace_td_tracking"))
```

```{r}
summary(reuse1.with("workplace_pair_programming"))
```

```{r}
summary(reuse1.with("workplace_coding_standards"))
```

```{r}
summary(reuse1.with("scenario"))
```

```{r}
summary(reuse1.with("group"))
```

```{r}
loo(
  reuse1.with(),
  reuse1.with("work_domain"),
  reuse1.with("work_experience_programming.s"),
  reuse1.with("work_experience_java.s"),
  reuse1.with("education_field"),
  reuse1.with(
  "mo(education_level)", 
    c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicconstructor"),
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicvalidation")
  )
  ),
  reuse1.with("workplace_peer_review"),
  reuse1.with("workplace_td_tracking"),
  reuse1.with("workplace_pair_programming"),
  reuse1.with("workplace_coding_standards"),
  reuse1.with("scenario"),
  reuse1.with("group"),
  reuse1.with(
  c("work_domain", 
    "work_experience_programming.s",
    "work_experience_java.s",
    "education_field",
    "mo(education_level)",
    "workplace_peer_review",
    "workplace_td_tracking",
    "workplace_pair_programming",
    "workplace_coding_standards",
    "scenario",
    "group"
    ),
    c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicconstructor"),
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1", resp = "reusedlogicvalidation")
  )
)
)


```

```{r}
reuse_cand1 <-   reuse1.with()
summary(reuse_cand1)
ranef(reuse_cand1)

plot(reuse_cand1)
pp_check(reuse_cand1, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand1, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand2 <-   reuse1.with("workplace_peer_review")
summary(reuse_cand2)
ranef(reuse_cand2)
plot(reuse_cand2)
pp_check(reuse_cand2, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand2, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand3 <- reuse1.with("workplace_coding_standards")
summary(reuse_cand3)
ranef(reuse_cand3)
plot(reuse_cand3)
pp_check(reuse_cand3, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand3, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand4 <-   reuse1.with("workplace_pair_programming")
summary(reuse_cand4)
ranef(reuse_cand4)
plot(reuse_cand4)
pp_check(reuse_cand4, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand4, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand34 <-   reuse1.with(c("workplace_pair_programming","workplace_coding_standards"))
summary(reuse_cand34)
ranef(reuse_cand34)
plot(reuse_cand34)
pp_check(reuse_cand34, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand34, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand23 <-   reuse1.with(c("workplace_peer_review","workplace_coding_standards"))
summary(reuse_cand23)
ranef(reuse_cand23)
plot(reuse_cand23)
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand42 <-   reuse1.with(c("workplace_peer_review","workplace_pair_programming"))
summary(reuse_cand23)
ranef(reuse_cand23)
plot(reuse_cand23)
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
reuse_cand234 <-   reuse1.with(c("workplace_peer_review","workplace_pair_programming","workplace_coding_standards"))
summary(reuse_cand23)
ranef(reuse_cand23)
plot(reuse_cand23)
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicconstructor")
pp_check(reuse_cand23, type = "bars", nsamples = 100, resp = "reusedlogicvalidation")
```

```{r}
loo(reuse_cand1,reuse_cand2,reuse_cand3,reuse_cand4,reuse_cand23,reuse_cand34,reuse_cand42,reuse_cand234)
```

Verdict: while candidates 2,3,4 are rated slightly better by loo, its very minor, and well within the margin of error. We choose cand 1, the one using only session and debt level as predictors.
