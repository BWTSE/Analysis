---
title: "SonarQube Issues"
output: html_notebook
---

## Looking at the data
it looks like there might be a difference between the high and low debt groups, the variance is decidedly higher in the high debt group.

```{r}
d.both_completed %>%
  ggplot(aes(x=sonarqube_issues, fill=high_debt_version)) + 
  geom_boxplot()

mean(d.both_completed$sonarqube_issues)
var(d.both_completed$sonarqube_issues)
```

## Descriptive Statistics:
Of full sample:
```{r}
mean(d.both_completed$sonarqube_issues)
var(d.both_completed$sonarqube_issues)
```

## Initial model
Variable names are modeled using the negative binomial family rather than poisson since the variance is much greater than the mean.

We include `high_debt_verison` as well as a varying intercept for each individual in our initial model.

### Selecting Priors
We iterate over the model until we have sane priors, in this case a prior giving a 50/50 chance was chosen in both cases.



```{r}
sonarqube_issues0.with <- extendable_model(
  base_name = "sonarqube_issues0",
  base_formula = "sonarqube_issues ~ 1 + high_debt_version + (1 | session)",
  base_priors = c(
    prior(normal(0, 1), class = "b"),
    prior(normal(1.5, 1), class = "Intercept"),
    prior(exponential(1), class = "sd"),
    prior(gamma(0.01, 0.01), class = "shape")
  ),
  family = negbinomial(),
  data = d.both_completed,
  base_control = list(adapt_delta = 0.95)
)


sonarqube_issues0 <- sonarqube_issues0.with()
summary(sonarqube_issues0)
```

## Model extensions

```{r}
summary(sonarqube_issues0.with("work_domain"))
```

```{r}
summary(sonarqube_issues0.with("work_experience_programming.s"))
```


```{r}
summary(sonarqube_issues0.with("work_experience_java.s"))
```

```{r}
summary(sonarqube_issues0.with("education_field"))
```

```{r}
summary(sonarqube_issues0.with(
  "mo(education_level)", 
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1")
  )
))
```

```{r}
summary(sonarqube_issues0.with("workplace_peer_review"))
```

```{r}
summary(sonarqube_issues0.with("workplace_td_tracking"))
```

```{r}
summary(sonarqube_issues0.with("workplace_pair_programming"))
```

```{r}
summary(sonarqube_issues0.with("workplace_coding_standards"))
```

```{r}
summary(sonarqube_issues0.with("scenario"))
```

```{r}
summary(sonarqube_issues0.with("group"))
```
```{r}
summary(
  sonarqube_issues0.with(
  c("work_domain", 
    "work_experience_programming.s",
    "work_experience_java.s",
    "education_field",
    "mo(education_level)",
    "workplace_peer_review",
    "workplace_td_tracking",
    "workplace_pair_programming",
    "workplace_coding_standards",
    "scenario",
    "group"
    ),
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1")
    )
  )
)

pp_check(
  sonarqube_issues0.with(
  c("work_domain", 
    "work_experience_programming.s",
    "work_experience_java.s",
    "education_field",
    "mo(education_level)",
    "workplace_peer_review",
    "workplace_td_tracking",
    "workplace_pair_programming",
    "workplace_coding_standards",
    "scenario",
    "group"
    ),
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1")
    )
  ),
  type = "bars",
  nsamples = "100"
)

```

```{r}

loo(
  sonarqube_issues0.with(),
  sonarqube_issues0.with("work_domain"),
  sonarqube_issues0.with("work_experience_programming.s"),
  sonarqube_issues0.with("work_experience_java.s"),
  sonarqube_issues0.with("education_field"),
  sonarqube_issues0.with(
  "mo(education_level)", 
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1")
  )
  ),
  sonarqube_issues0.with("workplace_peer_review"),
  sonarqube_issues0.with("workplace_td_tracking"),
  sonarqube_issues0.with("workplace_pair_programming"),
  sonarqube_issues0.with("workplace_coding_standards"),
  sonarqube_issues0.with("scenario"),
  sonarqube_issues0.with("group"),
  sonarqube_issues0.with(c("scenario","group")),
  sonarqube_issues0.with(
  c("work_domain", 
    "work_experience_programming.s",
    "work_experience_java.s",
    "education_field",
    "mo(education_level)",
    "workplace_peer_review",
    "workplace_td_tracking",
    "workplace_pair_programming",
    "workplace_coding_standards",
    "scenario",
    "group"
    ),
  c(
    prior(dirichlet(2), class = "simo", coef = "moeducation_level1")
    )
)
)
```

## Candidate models
We inspect some of our top performing models. 

All models seems to have sampled nicely (rhat = 1 and fluffy plots) they also have about the same fit to the data and similar estimates for the high_debt_version beta parameter.

```{r}
sonarqube_issues_cand1 <- sonarqube_issues0.with()
summary(sonarqube_issues_cand1)
ranef(sonarqube_issues_cand1)
plot(sonarqube_issues_cand1)
pp_check(sonarqube_issues_cand1, type = "bars", nsamples = 100)

```

```{r}

sonarqube_issues_cand2 <- sonarqube_issues0.with("scenario")
summary(sonarqube_issues_cand2)
ranef(sonarqube_issues_cand2)
plot(sonarqube_issues_cand2)
pp_check(sonarqube_issues_cand2, type = "bars", nsamples = 100)

```

```{r}
sonarqube_issues_cand3 <- sonarqube_issues0.with("group")
summary(sonarqube_issues_cand3)
ranef(sonarqube_issues_cand3)
plot(sonarqube_issues_cand3)
pp_check(sonarqube_issues_cand3, type = "bars", nsamples = 100)

```

```{r}

sonarqube_issues_cand4 <- sonarqube_issues0.with(c("group","scenario"))
summary(sonarqube_issues_cand4)
ranef(sonarqube_issues_cand4)
plot(sonarqube_issues_cand4)
pp_check(sonarqube_issues_cand4, type = "bars", nsamples = 100)

```

```{r}
loo(sonarqube_issues_cand1,sonarqube_issues_cand2,sonarqube_issues_cand3,sonarqube_issues_cand4)

```


```{r}

high_debt_predictions <- posterior_predict(sonarqube_issues_cand2, newdata = data.frame(session = NA,scenario = NA, high_debt_version ="true"))

low_debt_predictions <- posterior_predict(sonarqube_issues_cand2, newdata = data.frame(session = NA,scenario = NA, high_debt_version ="false"))



```

### Final model
Finally our winning candidate is compared vs a verison of itself using covariance. It is not significantly better, so we'll stick with var_names1

```{r}
sonarqube_issues_with_c <- brm(
  sonarqube_issues ~ 1 + (1 |c| session),
  family = negbinomial(),
  data = as.data.frame(d.both_completed),
  prior = c(
    prior(normal(1.5, 1), class = "Intercept"),
    prior(gamma(0.01,0.01), class = "shape")
  ),
  control = list(adapt_delta = 0.95),
  #empty = TRUE
  file = "fits/sonarqube_issues_with_c",
  file_refit = "on_change"
)

loo(sonarqube_issues_with_c, sonarqube_issues0.with())

```
### Model with with incomplete data points

Some participants only completed one scenario. Those has been excluded from the initial dataset to improve sampling of the models. We do however want to use all data we can and will therefore try to fit the model with the complete dataset.

```{r}
sonarqube_issues.all <- brm(
  sonarqube_issues ~ 1 + (1 | session) + high_debt_version,
  family = negbinomial(),
  data = as.data.frame(d.completed),
  prior = c(
    prior(normal(1.5, 1), class = "Intercept"),
    prior(gamma(0.01,0.01), class = "shape")
  ),
  control = list(adapt_delta = 0.95),
  #empty = TRUE
  file = "fits/sonarqube_issues.all",
  file_refit = "on_change"
)

summary(sonarqube_issues.all)
```

## Interpreting the model

Extract posterior samples:
```{r}

sonarqube_issues_post <- posterior_predict(sonarqube_issues.all, newdata = data.frame(high_debt_version = c("false", "true"), session = NA))
sonarqube_issues_post.low <-  sonarqube_issues_post[,1]
sonarqube_issues_post.high <- sonarqube_issues_post[,2]
sonarqube_issues_post.diff <- sonarqube_issues_post.high - sonarqube_issues_post.low

```


We can also plot the difference between good variable names for the high debt version and the low debt version. 
```{r}

ggplot(data.frame(x = sonarqube_issues_post.diff)) + geom_histogram(aes(x=x), stat = "count") +
  labs(
    title = "Diff of sonarqube issues",
    subtitle = "High debt group - low debt group",
    x ="number of issues",
    y = "observations"
  ) +
  xlim(-20,20) +
  theme_minimal() +
  scale_y_continuous(breaks = NULL)

```

Absolutely no effect...